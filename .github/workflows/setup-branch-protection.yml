name: Setup Branch Protection

# This workflow can be manually triggered to apply branch protection rules
# It uses the configuration defined in .github/branch-protection-config.yml

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to protect'
        required: true
        default: 'main'
        type: string

permissions:
  contents: read

jobs:
  apply-protection:
    name: Apply Branch Protection Rules
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Apply branch protection
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîê Applying branch protection rules to: ${{ inputs.branch }}"
          
          # Branch protection payload based on .github/branch-protection-config.yml
          PROTECTION_PAYLOAD='{
            "required_status_checks": {
              "strict": true,
              "contexts": [
                "WordPress Coding Standards",
                "PHP Compatibility Check",
                "Markdown Lint"
              ]
            },
            "enforce_admins": true,
            "required_pull_request_reviews": {
              "dismiss_stale_reviews": true,
              "require_code_owner_reviews": false,
              "required_approving_review_count": 1,
              "require_last_push_approval": true
            },
            "restrictions": null,
            "required_linear_history": true,
            "allow_force_pushes": false,
            "allow_deletions": false,
            "required_conversation_resolution": true,
            "block_creations": false,
            "lock_branch": false
          }'
          
          # Apply protection using GitHub CLI
          gh api \
            --method PUT \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/branches/${{ inputs.branch }}/protection" \
            --input - <<< "$PROTECTION_PAYLOAD"
          
          echo "‚úÖ Branch protection rules applied successfully!"
          echo ""
          echo "üìã Protection rules summary:"
          echo "  ‚Ä¢ Force pushes: DISABLED"
          echo "  ‚Ä¢ Branch deletion: DISABLED"
          echo "  ‚Ä¢ Pull request required: YES"
          echo "  ‚Ä¢ Approvals required: 1"
          echo "  ‚Ä¢ Status checks required: YES"
          echo "    - WordPress Coding Standards"
          echo "    - PHP Compatibility Check"
          echo "    - Markdown Lint"
          echo "  ‚Ä¢ Linear history: YES"
          echo "  ‚Ä¢ Admin enforcement: YES"

      - name: Verify protection
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîç Verifying branch protection settings..."
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/branches/${{ inputs.branch }}/protection" \
            --jq '{
              "required_status_checks": .required_status_checks.contexts,
              "required_approvals": .required_pull_request_reviews.required_approving_review_count,
              "allow_force_pushes": .allow_force_pushes.enabled,
              "allow_deletions": .allow_deletions.enabled,
              "enforce_admins": .enforce_admins.enabled
            }'
          echo "‚úÖ Verification complete!"
